import{d as F,ao as Y,an as O,r,e as $,o as g,c as H,m as a,i as e,X as Q,Y as Z,C as L,D as y,K as u,E as S,a as i,a3 as ee,V as k,t as n,_ as U,aa as te,a9 as ae,M as K,a2 as le,f as M,a4 as se,a7 as oe,A,B as re,av as ne,j as C,G as ie,H as ue,I as ce,J as de,L as me,a1 as T}from"./index-3b37923e.js";import{r as E,n as pe}from"./index-705cb9e8.js";const fe={class:"d-flex"},ve={class:"d-flex flex-column ms-1"},_e={class:"d-block whitespace-nowrap text-high-emphasis"},Ve=i("br",null,null,-1),ye={class:"text-error"},ge=F({__name:"TransferHistoryView",setup(N){const I=Y(),c=O.useToast(),d=r(!1),m=r(""),p=r("电影"),j=r([{title:"电影",value:"电影"},{title:"电视剧",value:"电视剧"}]),w=r(),q=[{title:"标题",key:"title",sortable:!1},{title:"目录",key:"src",sortable:!1},{title:"转移方式",key:"mode",sortable:!1},{title:"时间",key:"date",sortable:!1},{title:"状态",key:"status",sortable:!1},{title:"失败原因",key:"errmsg",sortable:!1},{title:"",key:"actions",sortable:!1}],P=r([]),f=r(""),h=r(!1),D=r(0),v=r(25),x=r(1);async function b({page:s,itemsPerPage:l}){h.value=!0;try{x.value=s;const o=await T.get("history/transfer",{params:{page:s,count:l,title:f.value}});P.value=o.data.list,D.value=o.data.total}catch(o){console.error(o)}h.value=!1}function z(s){return s==="电影"?"mdi-movie":s==="电视剧"?"mdi-television-classic":"mdi-help-circle"}function G(s){return s?"success":"error"}const J={copy:"复制",move:"移动",link:"硬链接",softlink:"软链接"};async function R(s){try{const l=await I({title:"确认",content:`同步删除 ${s.title} 对应的媒体库文件 ?`,confirmationText:"同步删除文件",cancellationText:"仅删除历史记录",dialogProps:{maxWidth:600}});let o=!1;l&&(o=!0);const _=await T.delete(`history/transfer?delete_file=${o}`,{data:s});_.success?b({page:x.value,itemsPerPage:v.value}):c.error(`删除失败: ${_.msg}`)}catch(l){console.error(l)}}async function B(){var s;try{if(!m.value||!p.value)return;d.value=!1,c.info(`正在重新整理 ${(s=w.value)==null?void 0:s.title} ...`);const l={...w.value},o=await T.post("history/transfer",l,{params:{mtype:p.value,new_tmdbid:parseInt(m.value)}});o.success?b({page:x.value,itemsPerPage:v.value}):c.error(`重新整理失败: ${o.message}！`)}catch(l){console.log(l)}}const W=r([{title:"重新整理",value:1,props:{prependIcon:"mdi-redo-variant",click:s=>{d.value=!0,w.value=s}}},{title:"删除",value:2,props:{prependIcon:"mdi-trash-can-outline",color:"error",click:R}}]);return(s,l)=>{const o=$("IconBtn"),_=$("VDataTableServer");return g(),H(K,null,[a(A,{class:"pb-5"},{default:e(()=>[a(Q,null,{default:e(()=>[a(Z,null,{default:e(()=>[a(L,null,{default:e(()=>[a(y,null,{default:e(()=>[u(" 历史记录 ")]),_:1}),a(y,null,{default:e(()=>[a(S,{key:"search_navbar",modelValue:f.value,"onUpdate:modelValue":l[0]||(l[0]=t=>f.value=t),class:"text-disabled",density:"compact",label:"搜索","append-inner-icon":"mdi-magnify",variant:"solo-filled","single-line":"","hide-details":"",flat:"",rounded:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),a(_,{"items-per-page":v.value,"onUpdate:itemsPerPage":l[1]||(l[1]=t=>v.value=t),headers:q,items:P.value,"items-length":D.value,search:f.value,loading:h.value,density:"compact","item-value":"id","return-object":"","fixed-header":"","items-per-page-text":"每页条数","page-text":"{0}-{1} 共 {2} 条","onUpdate:options":b},{"item.title":e(({item:t})=>[i("div",fe,[a(ee,null,{default:e(()=>[a(k,{icon:z(t.raw.type||"")},null,8,["icon"])]),_:2},1024),i("div",ve,[i("span",_e,n(t.raw.title)+" "+n(t.raw.seasons)+n(t.raw.episodes),1),i("small",null,n(t.raw.category),1)])])]),"item.src":e(({item:t})=>[i("small",null,[u(n(t.raw.src)+" ",1),Ve,u("=> "+n(t.raw.dest),1)])]),"item.mode":e(({item:t})=>[a(U,{variant:"outlined",color:"primary",size:"small"},{default:e(()=>[u(n(J[t.raw.mode]),1)]),_:2},1024)]),"item.status":e(({item:t})=>[a(U,{color:G(t.raw.status),size:"small"},{default:e(()=>[u(n(t.raw.status?"成功":"失败"),1)]),_:2},1032,["color"])]),"item.date":e(({item:t})=>[i("small",null,n(t.raw.date),1)]),"item.errmsg":e(({item:t})=>[i("small",ye,n(t.raw.errmsg),1)]),"item.actions":e(({item:t})=>[a(o,null,{default:e(()=>[a(k,{icon:"mdi-dots-vertical"}),a(te,{activator:"parent","close-on-content-click":""},{default:e(()=>[a(ae,null,{default:e(()=>[(g(!0),H(K,null,le(W.value,(V,X)=>(g(),M(oe,{key:X,variant:"plain","base-color":V.props.color,onClick:we=>V.props.click(t.raw)},{prepend:e(()=>[a(k,{icon:V.props.prependIcon},null,8,["icon"])]),default:e(()=>[a(se,{textContent:n(V.title)},null,8,["textContent"])]),_:2},1032,["base-color","onClick"]))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024)]),"no-data":e(()=>[u(" 没有数据 ")]),_:1},8,["items-per-page","items","items-length","search","loading"])]),_:1}),a(me,{modelValue:d.value,"onUpdate:modelValue":l[4]||(l[4]=t=>d.value=t),"max-width":"600"},{default:e(()=>[a(A,{title:"重新整理"},{default:e(()=>[a(re,null,{default:e(()=>[a(L,null,{default:e(()=>[a(y,{cols:"12",md:"4"},{default:e(()=>[a(ne,{modelValue:p.value,"onUpdate:modelValue":l[2]||(l[2]=t=>p.value=t),label:"类型",rules:[C(E)],items:j.value},null,8,["modelValue","rules","items"])]),_:1}),a(y,{cols:"12",md:"8"},{default:e(()=>[a(S,{modelValue:m.value,"onUpdate:modelValue":l[3]||(l[3]=t=>m.value=t),label:"TMDB编号",rules:[C(E),C(pe)]},null,8,["modelValue","rules"])]),_:1})]),_:1})]),_:1}),a(ie,null,{default:e(()=>[a(ue),a(ce,{onClick:B,onKeydown:de(B,["enter"])},{default:e(()=>[u(" 确定 ")]),_:1},8,["onKeydown"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}});const be=F({__name:"history",setup(N){return(I,c)=>(g(),M(ge))}});export{be as default};
