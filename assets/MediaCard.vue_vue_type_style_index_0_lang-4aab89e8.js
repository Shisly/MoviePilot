import{E as fe}from"./ExistIcon-bd8d77c8.js";import{d as be,an as pe,r as f,ay as _e,p as he,e as j,o as E,c as ge,m as d,i as r,A as R,z as ve,j as u,U as ye,n as D,a as v,R as F,S as q,_ as I,K as _,t as b,f as M,W as N,B as G,P as T,aC as we,aU as xe,aV as $e,F as J,G as ke,I as O,H as Ce,J as Se,L as Ve,M as Ee,ar as z,a1 as y,as as H,ae as W}from"./index-9a44e8f0.js";import{b as Ie}from"./formatters-080fb386.js";const Q="/assets/no-image-f5f483aa.jpeg",Be={class:"w-full h-full"},je={class:"font-bold"},De={class:"mb-1 text-white font-extrabold text-xl line-clamp-2 overflow-hidden text-ellipsis ..."},Me={class:"leading-4 line-clamp-4 overflow-hidden text-ellipsis ..."},Ne={class:"flex align-center justify-between"},Te={class:"d-block whitespace-nowrap"},Pe=be({__name:"MediaCard",props:{media:Object,width:String,height:String},setup(X){const t=X,h=pe.useToast(),$=f(!1),B=f(!1),L=f(!0),w=f(!1),k=f(!1),x=f({}),g=f(!1),C=f([]),S=f([]);function P(){g.value=!1,S.value.forEach(a=>{V(a.season_number)})}function U(a){return a==="电影"?"border-blue-500 bg-blue-600":a==="电视剧"?" bg-indigo-500 border-indigo-600":"border-purple-600 bg-purple-600"}async function Y(){var a,e,s,o,n;if(((a=t.media)==null?void 0:a.type)==="电视剧"&&((e=t.media)!=null&&e.tmdb_id)){if(await ie(),!C.value){h.error(`${(s=t.media)==null?void 0:s.title} 查询剧集信息失败！`);return}if(await oe(),!L.value)return;C.value.length===1?V(1):g.value=!0}else if(((o=t.media)==null?void 0:o.type)==="电视剧"){const l=((n=t.media)==null?void 0:n.season)??1;V(l)}else V()}async function V(a=0){var e,s,o,n,l,i,m;z();try{let p=k.value?1:0;a&&((e=t.media)!=null&&e.tmdb_id)&&(p=x.value[a]?0:1);const c=await y.post("subscribe",{name:(s=t.media)==null?void 0:s.title,type:(o=t.media)==null?void 0:o.type,year:(n=t.media)==null?void 0:n.year,tmdbid:(l=t.media)==null?void 0:l.tmdb_id,doubanid:(i=t.media)==null?void 0:i.douban_id,season:a,best_version:p});c.success&&(w.value=!0),Z(c.success,((m=t.media)==null?void 0:m.title)??"",a,c.message,p)}catch(p){console.error(p)}H()}function Z(a,e,s,o,n){s&&(e=`${e} ${Ie(s.toString())}`);let l="订阅";n>0&&(l="洗版订阅"),a?h.success(`${e} 添加${l}成功！`):h.error(`${e} 添加${l}失败：${o}！`)}async function ee(){var a,e,s,o,n,l;z();try{const i=(a=t.media)!=null&&a.tmdb_id?`tmdb:${(e=t.media)==null?void 0:e.tmdb_id}`:`douban:${(s=t.media)==null?void 0:s.douban_id}`,m=await y.delete(`subscribe/media/${i}`,{params:{season:(o=t.media)==null?void 0:o.season}});m.success?(w.value=!1,h.success(`${(n=t.media)==null?void 0:n.title} 已取消订阅！`)):h.error(`${(l=t.media)==null?void 0:l.title} 取消订阅失败：${m.message}！`)}catch(i){console.error(i)}H()}async function te(){var a;try{await se((a=t.media)==null?void 0:a.season)&&(w.value=!0)}catch(e){console.error(e)}}async function ae(){var a,e,s,o,n;try{(await y.get("media/exists",{params:{tmdbid:(a=t.media)==null?void 0:a.tmdb_id,title:(e=t.media)==null?void 0:e.title,year:(s=t.media)==null?void 0:s.year,season:(o=t.media)==null?void 0:o.season,mtype:(n=t.media)==null?void 0:n.type}})).success&&(k.value=!0)}catch(l){console.error(l)}}async function se(a=0){var e,s,o;try{const n=(e=t.media)!=null&&e.tmdb_id?`tmdb:${(s=t.media)==null?void 0:s.tmdb_id}`:`douban:${(o=t.media)==null?void 0:o.douban_id}`;return(await y.get(`subscribe/media/${n}`,{params:{season:a}})).id||null}catch(n){console.error(n)}return null}async function oe(){var a;z();try{const e=await y.post("download/notexists",t.media);e&&e.forEach(s=>{let o=0;s.episodes.length===0?o=2:s.episodes.length<s.total_episode&&(o=1),x.value[s.season]=o})}catch{h.error(`${(a=t.media)==null?void 0:a.title}无法识别TMDB媒体信息！`),L.value=!1}H()}async function ie(){var a;try{C.value=await y.get(`tmdb/seasons/${(a=t.media)==null?void 0:a.tmdb_id}`)}catch(e){console.error(e)}}function re(){w.value?ee():Y()}function ne(a){const e=x.value[a];return e?e===1?"warning":e===2?"error":"success":"success"}function le(a){const e=x.value[a];return e?e===1?"部分缺失":e===2?"缺失":"已存在":"已存在"}function de(){var a,e,s,o;W.push({path:"/media",query:{mediaid:`${(a=t.media)!=null&&a.tmdb_id?`tmdb:${(e=t.media)==null?void 0:e.tmdb_id}`:`douban:${(s=t.media)==null?void 0:s.douban_id}`}`,type:(o=t.media)==null?void 0:o.type}})}function ce(){var a,e,s,o;W.push({path:"/resource",query:{keyword:`${(a=t.media)!=null&&a.tmdb_id?`tmdb:${(e=t.media)==null?void 0:e.tmdb_id}`:`douban:${(s=t.media)==null?void 0:s.douban_id}`}`,type:(o=t.media)==null?void 0:o.type}})}_e(()=>{te(),ae()});const ue=[{title:"季",key:"title",sortable:!1},{title:"集数",key:"episodes",sortable:!1},{title:"评分",key:"vote",sortable:!1},{title:"状态",key:"status",sortable:!1}],me=he(()=>{var e,s;if(B.value)return Q;const a=((s=(e=t.media)==null?void 0:e.poster_path)==null?void 0:s.replace("original","w500"))??Q;return a.includes("doubanio.com")?`/api/v1/douban/img/${encodeURIComponent(a)}`:a});return(a,e)=>{const s=j("VSkeletonLoader"),o=fe,n=j("IconBtn"),l=j("VDataTable");return E(),ge(Ee,null,[d($e,we(xe(t)),{default:r(i=>[d(R,ve(i.props,{height:t.height,width:t.width,class:["outline-none shadow ring-gray-500 rounded-lg",{"transition transform-cpu duration-300 scale-105 shadow-lg":i.isHovering,"ring-1":u($)}]}),{default:r(()=>[d(ye,{"aspect-ratio":"2/3",src:u(me),class:D(["object-cover aspect-w-2 aspect-h-3",i.isHovering?"on-hover":""]),cover:"",onLoad:e[0]||(e[0]=m=>$.value=!0),onError:e[1]||(e[1]=m=>B.value=!0)},{placeholder:r(()=>[v("div",Be,[d(s,{class:"object-cover aspect-w-2 aspect-h-3"})])]),default:r(()=>{var m,p;return[F(d(I,{variant:"elevated",size:"small",class:D([U(((m=t.media)==null?void 0:m.type)||""),"absolute left-2 top-2 bg-opacity-80 shadow-md text-white font-bold"])},{default:r(()=>{var c;return[_(b((c=t.media)==null?void 0:c.type),1)]}),_:1},8,["class"]),[[q,u($)]]),u(k)?(E(),M(o,{key:0})):N("",!0),u($)&&((p=t.media)!=null&&p.vote_average)&&!u(k)?(E(),M(I,{key:1,variant:"elevated",size:"small",class:D([U("rating"),"absolute right-2 top-2 bg-opacity-80 shadow-md text-white font-bold"])},{default:r(()=>{var c;return[_(b((c=t.media)==null?void 0:c.vote_average),1)]}),_:1},8,["class"])):N("",!0),F(d(G,{class:"w-full flex flex-col flex-wrap justify-end align-left text-white absolute bottom-0 cursor-pointer pa-2",onClick:T(de,["stop"])},{default:r(()=>{var c,A,K;return[v("span",je,b((c=t.media)==null?void 0:c.year),1),v("h1",De,b((A=t.media)==null?void 0:A.title),1),v("p",Me,b((K=t.media)==null?void 0:K.overview),1),v("div",Ne,[d(n,{icon:"mdi-magnify",color:"white",onClick:T(ce,["stop"])},null,8,["onClick"]),d(n,{icon:"mdi-heart",color:u(w)?"error":"white",onClick:T(re,["stop"])},null,8,["color","onClick"])])]}),_:2},1032,["onClick"]),[[q,i.isHovering||u(B)]])]}),_:2},1032,["src","class"])]),_:2},1040,["height","width","class"])]),_:1},16),d(Ve,{modelValue:u(g),"onUpdate:modelValue":e[4]||(e[4]=i=>J(g)?g.value=i:null),"max-width":"600","content-class":"whitespace-nowrap",scrollable:""},{default:r(()=>[d(R,{title:"选择订阅季"},{default:r(()=>[d(G,{style:{padding:"0"}},{default:r(()=>[d(l,{modelValue:u(S),"onUpdate:modelValue":e[2]||(e[2]=i=>J(S)?S.value=i:null),headers:ue,items:u(C),"item-value":"season_number","return-object":"","fixed-header":"","show-select":"","items-per-page":100,density:"compact",height:"auto"},{"item.title":r(({item:i})=>[v("span",Te,"第 "+b(i.raw.season_number)+" 季 ",1)]),"item.episodes":r(({item:i})=>[d(I,{variant:"outlined",size:"small"},{default:r(()=>[_(b(i.raw.episode_count),1)]),_:2},1024)]),"item.vote":r(({item:i})=>[_(b(i.raw.vote_average),1)]),"item.status":r(({item:i})=>[u(x)?(E(),M(I,{key:0,color:ne(i.raw.season_number),flat:"",size:"small"},{default:r(()=>[_(b(le(i.raw.season_number)),1)]),_:2},1032,["color"])):N("",!0)]),"no-data":r(()=>[_(" 没有数据 ")]),bottom:r(()=>[]),_:1},8,["modelValue","items"])]),_:1}),d(ke,null,{default:r(()=>[d(O,{onClick:e[3]||(e[3]=i=>g.value=!1)},{default:r(()=>[_(" 取消 ")]),_:1}),d(Ce),d(O,{onClick:P,onKeydown:Se(P,["enter"])},{default:r(()=>[_(" 确定 ")]),_:1},8,["onKeydown"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}});export{Pe as _};
