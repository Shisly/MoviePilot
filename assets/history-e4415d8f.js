import{d as J,ap as oe,ao as re,r,e as z,o as f,c as P,m as e,i as a,X as ne,Y as ie,C as A,D as b,K as u,E,a as c,a3 as ue,V as I,t as n,_ as M,aa as ce,a9 as de,M as W,a2 as me,f as R,a4 as fe,a7 as pe,A as B,B as j,aw as ve,j as $,G as _e,H as ge,I as q,J as Ve,L as F,W as ye,ai as he,a1 as D}from"./index-7936348a.js";import{r as G,n as we}from"./index-705cb9e8.js";const xe={class:"d-flex"},be={class:"d-flex flex-column ms-1"},ke={class:"d-block whitespace-nowrap text-high-emphasis"},Ce=c("br",null,null,-1),Te={class:"text-error"},Pe={key:0,class:"fixed right-5 bottom-5"},Ie=J({__name:"TransferHistoryView",setup(X){const k=oe(),p=re.useToast(),v=r(!1),_=r(""),g=r("电影"),Y=r([{title:"电影",value:"电影"},{title:"电视剧",value:"电视剧"}]),C=r(),i=r([]),O=[{title:"标题",key:"title",sortable:!1},{title:"目录",key:"src",sortable:!1},{title:"转移方式",key:"mode",sortable:!1},{title:"时间",key:"date",sortable:!1},{title:"状态",key:"status",sortable:!1},{title:"失败原因",key:"errmsg",sortable:!1},{title:"",key:"actions",sortable:!1}],U=r([]),V=r(""),T=r(!1),H=r(0),m=r(25),y=r(1),h=r(!1),L=r("请稍候 ..."),S=r(0);async function w({page:s,itemsPerPage:l}){T.value=!0;try{y.value=s;const o=await D.get("history/transfer",{params:{page:s,count:l,title:V.value}});U.value=o.data.list,H.value=o.data.total}catch(o){console.error(o)}T.value=!1}function Q(s){return s==="电影"?"mdi-movie":s==="电视剧"?"mdi-television-classic":"mdi-help-circle"}function Z(s){return s?"success":"error"}const ee={copy:"复制",move:"移动",link:"硬链接",softlink:"软链接"};async function te(s){const l=await k({title:"确认",content:`同步删除 ${s.title} 对应的媒体库文件 ?`,confirmationText:"同步删除文件",cancellationText:"仅删除历史记录",dialogProps:{maxWidth:600},confirmationButtonProps:{color:"error"}});l!==void 0&&(K(s,l||!1),i.value=[])}async function K(s,l){try{const o=await D.delete(`history/transfer?delete_file=${l}`,{data:s});o.success?w({page:y.value,itemsPerPage:m.value}):p.error(`删除失败: ${o.msg}`)}catch(o){console.error(o)}}async function ae(){if(i.value.length===0)return;const s=await k({title:"确认",content:`同步删除 ${i.value.length} 条记录对应的媒体库文件 ?`,confirmationText:"同步删除文件",cancellationText:"仅删除历史记录",dialogProps:{maxWidth:600},confirmationButtonProps:{color:"error"}});if(s===void 0)return;console.log(i.value);const l=i.value.length;let o=0;h.value=!0;for(const d of i.value)L.value=`正在删除 ${d.title} ${d.seasons}${d.episodes} ...`,await K(d,s||!1),o++,S.value=o/l*100;i.value=[],h.value=!1,w({page:y.value,itemsPerPage:m.value})}async function N(){var s;try{if(!_.value||!g.value)return;v.value=!1,p.info(`正在重新整理 ${(s=C.value)==null?void 0:s.title} ...`);const l={...C.value},o=await D.post("history/transfer",l,{params:{mtype:g.value,new_tmdbid:parseInt(_.value)}});o.success?w({page:y.value,itemsPerPage:m.value}):p.error(`重新整理失败: ${o.message}！`)}catch(l){console.log(l)}}const le=r([{title:"重新整理",value:1,props:{prependIcon:"mdi-redo-variant",click:s=>{v.value=!0,C.value=s}}},{title:"删除",value:2,props:{prependIcon:"mdi-trash-can-outline",color:"error",click:te}}]);return(s,l)=>{const o=z("IconBtn"),d=z("VDataTableServer");return f(),P(W,null,[e(B,{class:"pb-5"},{default:a(()=>[e(ne,null,{default:a(()=>[e(ie,null,{default:a(()=>[e(A,null,{default:a(()=>[e(b,null,{default:a(()=>[u(" 历史记录 ")]),_:1}),e(b,null,{default:a(()=>[e(E,{key:"search_navbar",modelValue:V.value,"onUpdate:modelValue":l[0]||(l[0]=t=>V.value=t),class:"text-disabled",density:"compact",label:"搜索","append-inner-icon":"mdi-magnify",variant:"solo-filled","single-line":"","hide-details":"",flat:"",rounded:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),e(d,{modelValue:i.value,"onUpdate:modelValue":l[1]||(l[1]=t=>i.value=t),"items-per-page":m.value,"onUpdate:itemsPerPage":l[2]||(l[2]=t=>m.value=t),headers:O,items:U.value,"items-length":H.value,search:V.value,loading:T.value,density:"compact","item-value":"id","return-object":"","fixed-header":"","show-select":"","items-per-page-text":"每页条数","page-text":"{0}-{1} 共 {2} 条","onUpdate:options":w},{"item.title":a(({item:t})=>[c("div",xe,[e(ue,null,{default:a(()=>[e(I,{icon:Q(t.raw.type||"")},null,8,["icon"])]),_:2},1024),c("div",be,[c("span",ke,n(t.raw.title)+" "+n(t.raw.seasons)+n(t.raw.episodes),1),c("small",null,n(t.raw.category),1)])])]),"item.src":a(({item:t})=>[c("small",null,[u(n(t.raw.src)+" ",1),Ce,u("=> "+n(t.raw.dest),1)])]),"item.mode":a(({item:t})=>[e(M,{variant:"outlined",color:"primary",size:"small"},{default:a(()=>[u(n(ee[t.raw.mode]),1)]),_:2},1024)]),"item.status":a(({item:t})=>[e(M,{color:Z(t.raw.status),size:"small"},{default:a(()=>[u(n(t.raw.status?"成功":"失败"),1)]),_:2},1032,["color"])]),"item.date":a(({item:t})=>[c("small",null,n(t.raw.date),1)]),"item.errmsg":a(({item:t})=>[c("small",Te,n(t.raw.errmsg),1)]),"item.actions":a(({item:t})=>[e(o,null,{default:a(()=>[e(I,{icon:"mdi-dots-vertical"}),e(ce,{activator:"parent","close-on-content-click":""},{default:a(()=>[e(de,null,{default:a(()=>[(f(!0),P(W,null,me(le.value,(x,se)=>(f(),R(pe,{key:se,variant:"plain","base-color":x.props.color,onClick:Be=>x.props.click(t.raw)},{prepend:a(()=>[e(I,{icon:x.props.prependIcon},null,8,["icon"])]),default:a(()=>[e(fe,{textContent:n(x.title)},null,8,["textContent"])]),_:2},1032,["base-color","onClick"]))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024)]),"no-data":a(()=>[u(" 没有数据 ")]),_:1},8,["modelValue","items-per-page","items","items-length","search","loading"])]),_:1}),e(F,{modelValue:v.value,"onUpdate:modelValue":l[5]||(l[5]=t=>v.value=t),"max-width":"600"},{default:a(()=>[e(B,{title:"重新整理"},{default:a(()=>[e(j,null,{default:a(()=>[e(A,null,{default:a(()=>[e(b,{cols:"12",md:"4"},{default:a(()=>[e(ve,{modelValue:g.value,"onUpdate:modelValue":l[3]||(l[3]=t=>g.value=t),label:"类型",rules:[$(G)],items:Y.value},null,8,["modelValue","rules","items"])]),_:1}),e(b,{cols:"12",md:"8"},{default:a(()=>[e(E,{modelValue:_.value,"onUpdate:modelValue":l[4]||(l[4]=t=>_.value=t),label:"TMDB编号",rules:[$(G),$(we)]},null,8,["modelValue","rules"])]),_:1})]),_:1})]),_:1}),e(_e,null,{default:a(()=>[e(ge),e(q,{onClick:N,onKeydown:Ve(N,["enter"])},{default:a(()=>[u(" 确定 ")]),_:1},8,["onKeydown"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),i.value.length>0?(f(),P("span",Pe,[e(q,{icon:"mdi-trash-can-outline",color:"error",size:"x-large",onClick:ae})])):ye("",!0),e(F,{modelValue:h.value,"onUpdate:modelValue":l[6]||(l[6]=t=>h.value=t),scrim:!1,width:"400"},{default:a(()=>[e(B,{color:"primary"},{default:a(()=>[e(j,{class:"text-center"},{default:a(()=>[u(n(L.value)+" ",1),e(he,{color:"white",class:"mb-0 mt-1","model-value":S.value},null,8,["model-value"])]),_:1})]),_:1})]),_:1},8,["modelValue"])],64)}}});const Ue=J({__name:"history",setup(X){return(k,p)=>(f(),R(Ie))}});export{Ue as default};
