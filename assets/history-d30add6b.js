import{d as R,ae as re,af as ne,r,e as E,o as p,c as I,m as t,i as l,aa as ie,ab as ue,C as M,D as k,K as u,E as W,a as d,X as de,V as $,t as n,a4 as j,ac as ce,a2 as me,M as q,W as fe,f as X,Y as pe,a0 as ve,A as B,B as F,a8 as Ve,j as D,G as ge,H as _e,I as G,J as ye,L as U,$ as we,ai as xe}from"./index-49c87d9c.js";import{r as J,n as be}from"./index-705cb9e8.js";import{a as H}from"./index-c83b720a.js";import{_ as he}from"./TmdbSelectorCard.vue_vue_type_script_setup_true_lang-7326654d.js";const ke={class:"d-flex"},Ce={class:"d-flex flex-column ms-1"},Te={class:"d-block whitespace-nowrap text-high-emphasis"},Pe=d("br",null,null,-1),Ie={class:"text-error"},$e={key:0,class:"fixed right-5 bottom-5"},Be=R({__name:"TransferHistoryView",setup(Y){const C=re(),v=ne.useToast(),V=r(!1),c=r(""),g=r("电影"),O=r([{title:"电影",value:"电影"},{title:"电视剧",value:"电视剧"}]),T=r(),i=r([]),Q=[{title:"标题",key:"title",sortable:!1},{title:"目录",key:"src",sortable:!1},{title:"转移方式",key:"mode",sortable:!1},{title:"时间",key:"date",sortable:!1},{title:"状态",key:"status",sortable:!1},{title:"失败原因",key:"errmsg",sortable:!1},{title:"",key:"actions",sortable:!1}],L=r([]),_=r(""),P=r(!1),S=r(0),f=r(25),y=r(1),w=r(!1),K=r("请稍候 ..."),N=r(0),x=r(!1);async function b({page:o,itemsPerPage:a}){P.value=!0;try{y.value=o;const s=await H.get("history/transfer",{params:{page:o,count:a,title:_.value}});L.value=s.data.list,S.value=s.data.total}catch(s){console.error(s)}P.value=!1}function Z(o){return o==="电影"?"mdi-movie":o==="电视剧"?"mdi-television-classic":"mdi-help-circle"}function ee(o){return o?"success":"error"}const te={copy:"复制",move:"移动",link:"硬链接",softlink:"软链接"};async function ae(o){const a=await C({title:"确认",content:`同步删除 ${o.title} 对应的媒体库文件 ?`,confirmationText:"同步删除文件",cancellationText:"仅删除历史记录",dialogProps:{maxWidth:"50rem"},confirmationButtonProps:{color:"error"}});a!==void 0&&(z(o,a||!1),i.value=[])}async function z(o,a){try{const s=await H.delete(`history/transfer?delete_file=${a}`,{data:o});s.success?b({page:y.value,itemsPerPage:f.value}):v.error(`删除失败: ${s.msg}`)}catch(s){console.error(s)}}async function le(){if(i.value.length===0)return;const o=await C({title:"确认",content:`同步删除 ${i.value.length} 条记录对应的媒体库文件 ?`,confirmationText:"同步删除文件",cancellationText:"仅删除历史记录",dialogProps:{maxWidth:"50rem"},confirmationButtonProps:{color:"error"}});if(o===void 0)return;console.log(i.value);const a=i.value.length;let s=0;w.value=!0;for(const m of i.value)K.value=`正在删除 ${m.title} ${m.seasons}${m.episodes} ...`,await z(m,o||!1),s++,N.value=s/a*100;i.value=[],w.value=!1,b({page:y.value,itemsPerPage:f.value})}async function A(){var o;try{if(!c.value||!g.value)return;V.value=!1,v.info(`正在重新整理 ${(o=T.value)==null?void 0:o.title} ...`);const a={...T.value},s=await H.post("history/transfer",a,{params:{mtype:g.value,new_tmdbid:parseInt(c.value)}});s.success?b({page:y.value,itemsPerPage:f.value}):v.error(`重新整理失败: ${s.message}！`)}catch(a){console.log(a)}}const oe=r([{title:"重新整理",value:1,props:{prependIcon:"mdi-redo-variant",click:o=>{V.value=!0,T.value=o}}},{title:"删除",value:2,props:{prependIcon:"mdi-trash-can-outline",color:"error",click:ae}}]);return(o,a)=>{const s=E("IconBtn"),m=E("VDataTableServer");return p(),I(q,null,[t(B,{class:"pb-5"},{default:l(()=>[t(ie,null,{default:l(()=>[t(ue,null,{default:l(()=>[t(M,null,{default:l(()=>[t(k,null,{default:l(()=>[u(" 历史记录 ")]),_:1}),t(k,null,{default:l(()=>[t(W,{key:"search_navbar",modelValue:_.value,"onUpdate:modelValue":a[0]||(a[0]=e=>_.value=e),class:"text-disabled",density:"compact",label:"搜索","append-inner-icon":"mdi-magnify",variant:"solo-filled","single-line":"","hide-details":"",flat:"",rounded:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),t(m,{modelValue:i.value,"onUpdate:modelValue":a[1]||(a[1]=e=>i.value=e),"items-per-page":f.value,"onUpdate:itemsPerPage":a[2]||(a[2]=e=>f.value=e),headers:Q,items:L.value,"items-length":S.value,search:_.value,loading:P.value,density:"compact","item-value":"id","return-object":"","fixed-header":"","show-select":"","items-per-page-text":"每页条数","page-text":"{0}-{1} 共 {2} 条","onUpdate:options":b},{"item.title":l(({item:e})=>[d("div",ke,[t(de,null,{default:l(()=>[t($,{icon:Z(e.raw.type||"")},null,8,["icon"])]),_:2},1024),d("div",Ce,[d("span",Te,n(e.raw.title)+" "+n(e.raw.seasons)+n(e.raw.episodes),1),d("small",null,n(e.raw.category),1)])])]),"item.src":l(({item:e})=>[d("small",null,[u(n(e.raw.src)+" ",1),Pe,u("=> "+n(e.raw.dest),1)])]),"item.mode":l(({item:e})=>[t(j,{variant:"outlined",color:"primary",size:"small"},{default:l(()=>[u(n(te[e.raw.mode]),1)]),_:2},1024)]),"item.status":l(({item:e})=>[t(j,{color:ee(e.raw.status),size:"small"},{default:l(()=>[u(n(e.raw.status?"成功":"失败"),1)]),_:2},1032,["color"])]),"item.date":l(({item:e})=>[d("small",null,n(e.raw.date),1)]),"item.errmsg":l(({item:e})=>[d("small",Ie,n(e.raw.errmsg),1)]),"item.actions":l(({item:e})=>[t(s,null,{default:l(()=>[t($,{icon:"mdi-dots-vertical"}),t(ce,{activator:"parent","close-on-content-click":""},{default:l(()=>[t(me,null,{default:l(()=>[(p(!0),I(q,null,fe(oe.value,(h,se)=>(p(),X(ve,{key:se,variant:"plain","base-color":h.props.color,onClick:De=>h.props.click(e.raw)},{prepend:l(()=>[t($,{icon:h.props.prependIcon},null,8,["icon"])]),default:l(()=>[t(pe,{textContent:n(h.title)},null,8,["textContent"])]),_:2},1032,["base-color","onClick"]))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024)]),"no-data":l(()=>[u(" 没有数据 ")]),_:1},8,["modelValue","items-per-page","items","items-length","search","loading"])]),_:1}),t(U,{modelValue:V.value,"onUpdate:modelValue":a[6]||(a[6]=e=>V.value=e),"max-width":"50rem"},{default:l(()=>[t(B,{title:"重新整理"},{default:l(()=>[t(F,null,{default:l(()=>[t(M,null,{default:l(()=>[t(k,{cols:"12",md:"4"},{default:l(()=>[t(Ve,{modelValue:g.value,"onUpdate:modelValue":a[3]||(a[3]=e=>g.value=e),label:"类型",rules:[D(J)],items:O.value},null,8,["modelValue","rules","items"])]),_:1}),t(k,{cols:"12",md:"8"},{default:l(()=>[t(W,{modelValue:c.value,"onUpdate:modelValue":a[4]||(a[4]=e=>c.value=e),label:"TMDB编号",rules:[D(J),D(be)],"append-inner-icon":"mdi-magnify","onClick:appendInner":a[5]||(a[5]=e=>x.value=!0)},null,8,["modelValue","rules"])]),_:1})]),_:1})]),_:1}),t(ge,null,{default:l(()=>[t(_e),t(G,{onClick:A,onKeydown:ye(A,["enter"])},{default:l(()=>[u(" 确定 ")]),_:1},8,["onKeydown"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),i.value.length>0?(p(),I("span",$e,[t(G,{icon:"mdi-trash-can-outline",color:"error",size:"x-large",onClick:le})])):we("",!0),t(U,{modelValue:w.value,"onUpdate:modelValue":a[7]||(a[7]=e=>w.value=e),scrim:!1,width:"25rem"},{default:l(()=>[t(B,{color:"primary"},{default:l(()=>[t(F,{class:"text-center"},{default:l(()=>[u(n(K.value)+" ",1),t(xe,{color:"white",class:"mb-0 mt-1","model-value":N.value},null,8,["model-value"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(U,{modelValue:x.value,"onUpdate:modelValue":a[10]||(a[10]=e=>x.value=e),width:"600",scrollable:""},{default:l(()=>[t(he,{modelValue:c.value,"onUpdate:modelValue":a[8]||(a[8]=e=>c.value=e),onClose:a[9]||(a[9]=e=>x.value=!1)},null,8,["modelValue"])]),_:1},8,["modelValue"])],64)}}});const Ke=R({__name:"history",setup(Y){return(C,v)=>(p(),X(Be))}});export{Ke as default};
