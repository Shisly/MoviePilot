import{_ as ve}from"./DialogCloseBtn.vue_vue_type_script_setup_true_lang-36d13681.js";import{d as O,af as fe,r as o,e as L,o as b,c as z,m as a,i as t,aa as pe,ab as J,C as R,D as B,K as i,E as W,a as v,X as Ve,V as K,t as d,a4 as X,ac as ge,a2 as ye,M as Y,W as _e,f as Q,Y as we,a0 as xe,A as P,B as q,a8 as be,j as ke,P as Ce,G as he,H as $e,I as V,J as Ie,L as M,$ as Te,ai as Be}from"./index-58b74c2b.js";import{n as Pe}from"./index-705cb9e8.js";import{a as N}from"./index-153cde90.js";import{_ as De}from"./TmdbSelectorCard.vue_vue_type_script_setup_true_lang-316629dc.js";const Ue={class:"d-flex"},Se={class:"d-flex flex-column ms-1"},He={class:"d-block whitespace-nowrap text-high-emphasis"},Le=v("br",null,null,-1),ze={class:"text-error"},Ke={key:0,class:"fixed right-5 bottom-5"},Me={class:"d-flex flex-column flex-lg-row justify-center my-3"},Ne=O({__name:"TransferHistoryView",setup(Z){const w=fe.useToast(),g=o(!1),f=o(""),y=o("电影"),ee=o([{title:"自动",value:""},{title:"电影",value:"电影"},{title:"电视剧",value:"电视剧"}]),c=o(),u=o([]),le=[{title:"标题",key:"title",sortable:!1},{title:"目录",key:"src",sortable:!1},{title:"转移方式",key:"mode",sortable:!1},{title:"时间",key:"date",sortable:!1},{title:"状态",key:"status",sortable:!1},{title:"失败原因",key:"errmsg",sortable:!1},{title:"",key:"actions",sortable:!1}],j=o([]),k=o(""),D=o(!1),A=o(0),x=o(25),C=o(1),_=o(!1),U=o("请稍候 ..."),S=o(0),h=o(!1),p=o(!1),H=o("");async function $({page:s,itemsPerPage:e}){D.value=!0;try{C.value=s;const n=await N.get("history/transfer",{params:{page:s,count:e,title:k.value}});j.value=n.data.list,A.value=n.data.total}catch(n){console.error(n)}D.value=!1}function ae(s){return s==="电影"?"mdi-movie":s==="电视剧"?"mdi-television-classic":"mdi-help-circle"}function te(s){return s?"success":"error"}const se={copy:"复制",move:"移动",link:"硬链接",softlink:"软链接"};async function oe(s){c.value=s,H.value=`确认删除 ${s.title} ${s.seasons}${s.episodes} ?`,p.value=!0}async function E(s,e,n){try{const r=await N.delete(`history/transfer?deletesrc=${e}&deletedest=${n}`,{data:s});r.success||w.error(`删除失败: ${r.msg}`)}catch(r){console.error(r)}}async function re(s,e){p.value=!1,c.value&&(await E(c.value,s,e),$({page:C.value,itemsPerPage:x.value}))}async function ne(s,e){p.value=!1;const n=u.value.length;if(n===0)return;let r=0;_.value=!0;for(const m of u.value)U.value=`正在删除 ${m.title} ${m.seasons}${m.episodes} ...`,await E(m,s,e),r++,S.value=r/n*100;u.value=[],_.value=!1,$({page:C.value,itemsPerPage:x.value})}async function I(s,e){c.value?await re(s,e):await ne(s,e)}async function ue(){u.value.length!==0&&(c.value=void 0,H.value=`确认删除 ${u.value.length} 条记录 ?`,p.value=!0)}async function ie(){u.value.length!==0&&(c.value=void 0,y.value="",g.value=!0)}async function F(s,e="",n=0){try{const r=await N.post("history/transfer",s,{params:{mtype:e,new_tmdbid:n}});r.success?$({page:C.value,itemsPerPage:x.value}):w.error(`重新整理失败: ${r.message}！`)}catch(r){console.log(r)}}async function G(){var s;try{g.value=!1;let e=0;if(f.value&&(e=parseInt(f.value)),c.value)w.info(`正在重新整理 ${(s=c.value)==null?void 0:s.title} ...`),await F(c.value,y.value,e);else if(u.value.length>0){const n=u.value.length;if(n===0)return;let r=0;_.value=!0;for(const m of u.value)U.value=`正在重新整理 ${m.src} ...`,await F(m,y.value,e),r++,S.value=r/n*100;u.value=[],_.value=!1}else w.error("没有选中任何记录！")}catch(e){console.log(e)}}const de=o([{title:"重新整理",value:1,props:{prependIcon:"mdi-redo-variant",click:s=>{f.value="",y.value="",g.value=!0,c.value=s}}},{title:"删除",value:2,props:{prependIcon:"mdi-trash-can-outline",color:"error",click:s=>{oe(s)}}}]);return(s,e)=>{const n=L("IconBtn"),r=L("VDataTableServer"),m=ve,ce=L("VBottomSheet");return b(),z(Y,null,[a(P,{class:"pb-5"},{default:t(()=>[a(pe,null,{default:t(()=>[a(J,null,{default:t(()=>[a(R,null,{default:t(()=>[a(B,null,{default:t(()=>[i(" 历史记录 ")]),_:1}),a(B,null,{default:t(()=>[a(W,{key:"search_navbar",modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=l=>k.value=l),class:"text-disabled",density:"compact",label:"搜索","append-inner-icon":"mdi-magnify",variant:"solo-filled","single-line":"","hide-details":"",flat:"",rounded:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1}),a(r,{modelValue:u.value,"onUpdate:modelValue":e[1]||(e[1]=l=>u.value=l),"items-per-page":x.value,"onUpdate:itemsPerPage":e[2]||(e[2]=l=>x.value=l),headers:le,items:j.value,"items-length":A.value,search:k.value,loading:D.value,density:"compact","item-value":"id","return-object":"","fixed-header":"","show-select":"","items-per-page-text":"每页条数","page-text":"{0}-{1} 共 {2} 条","onUpdate:options":$},{"item.title":t(({item:l})=>[v("div",Ue,[a(Ve,null,{default:t(()=>[a(K,{icon:ae(l.raw.type||"")},null,8,["icon"])]),_:2},1024),v("div",Se,[v("span",He,d(l.raw.title)+" "+d(l.raw.seasons)+d(l.raw.episodes),1),v("small",null,d(l.raw.category),1)])])]),"item.src":t(({item:l})=>[v("small",null,[i(d(l.raw.src)+" ",1),Le,i("=> "+d(l.raw.dest),1)])]),"item.mode":t(({item:l})=>[a(X,{variant:"outlined",color:"primary",size:"small"},{default:t(()=>[i(d(se[l.raw.mode]),1)]),_:2},1024)]),"item.status":t(({item:l})=>[a(X,{color:te(l.raw.status),size:"small"},{default:t(()=>[i(d(l.raw.status?"成功":"失败"),1)]),_:2},1032,["color"])]),"item.date":t(({item:l})=>[v("small",null,d(l.raw.date),1)]),"item.errmsg":t(({item:l})=>[v("small",ze,d(l.raw.errmsg),1)]),"item.actions":t(({item:l})=>[a(n,null,{default:t(()=>[a(K,{icon:"mdi-dots-vertical"}),a(ge,{activator:"parent","close-on-content-click":""},{default:t(()=>[a(ye,null,{default:t(()=>[(b(!0),z(Y,null,_e(de.value,(T,me)=>(b(),Q(xe,{key:me,variant:"plain","base-color":T.props.color,onClick:je=>T.props.click(l.raw)},{prepend:t(()=>[a(K,{icon:T.props.prependIcon},null,8,["icon"])]),default:t(()=>[a(we,{textContent:d(T.title)},null,8,["textContent"])]),_:2},1032,["base-color","onClick"]))),128))]),_:2},1024)]),_:2},1024)]),_:2},1024)]),"no-data":t(()=>[i(" 没有数据 ")]),_:1},8,["modelValue","items-per-page","items","items-length","search","loading"])]),_:1}),a(M,{modelValue:g.value,"onUpdate:modelValue":e[6]||(e[6]=l=>g.value=l),"max-width":"50rem"},{default:t(()=>[a(P,{title:"重新整理"},{default:t(()=>[a(q,null,{default:t(()=>[a(R,null,{default:t(()=>[a(B,{cols:"12",md:"4"},{default:t(()=>[a(be,{modelValue:y.value,"onUpdate:modelValue":e[3]||(e[3]=l=>y.value=l),label:"类型",items:ee.value},null,8,["modelValue","items"])]),_:1}),a(B,{cols:"12",md:"8"},{default:t(()=>[a(W,{modelValue:f.value,"onUpdate:modelValue":e[4]||(e[4]=l=>f.value=l),label:"TMDB编号",placeholder:"留空自动识别",rules:[ke(Pe)],"append-inner-icon":"mdi-magnify","onClick:appendInner":e[5]||(e[5]=Ce(l=>h.value=!0,["stop"]))},null,8,["modelValue","rules"])]),_:1})]),_:1})]),_:1}),a(he,null,{default:t(()=>[a($e),a(V,{onClick:G,onKeydown:Ie(G,["enter"])},{default:t(()=>[i(" 确定 ")]),_:1},8,["onKeydown"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),u.value.length>0?(b(),z("span",Ke,[a(V,{icon:"mdi-redo-variant",class:"me-2",color:"primary",size:"x-large",onClick:ie}),a(V,{icon:"mdi-trash-can-outline",color:"error",size:"x-large",onClick:ue})])):Te("",!0),a(M,{modelValue:_.value,"onUpdate:modelValue":e[7]||(e[7]=l=>_.value=l),scrim:!1,width:"25rem"},{default:t(()=>[a(P,{color:"primary"},{default:t(()=>[a(q,{class:"text-center"},{default:t(()=>[i(d(U.value)+" ",1),a(Be,{color:"white",class:"mb-0 mt-1","model-value":S.value},null,8,["model-value"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(M,{modelValue:h.value,"onUpdate:modelValue":e[10]||(e[10]=l=>h.value=l),width:"600",scrollable:""},{default:t(()=>[a(De,{modelValue:f.value,"onUpdate:modelValue":e[8]||(e[8]=l=>f.value=l),onClose:e[9]||(e[9]=l=>h.value=!1)},null,8,["modelValue"])]),_:1},8,["modelValue"]),a(ce,{modelValue:p.value,"onUpdate:modelValue":e[16]||(e[16]=l=>p.value=l),inset:""},{default:t(()=>[a(P,{class:"text-center"},{default:t(()=>[a(m,{onClick:e[11]||(e[11]=l=>p.value=!1)}),a(J,{class:"pe-10"},{default:t(()=>[i(d(H.value),1)]),_:1}),v("div",Me,[a(V,{color:"primary",class:"mb-2 mx-2",onClick:e[12]||(e[12]=l=>I(!1,!1))},{default:t(()=>[i(" 仅删除历史记录 ")]),_:1}),a(V,{color:"warning",class:"mb-2 mx-2",onClick:e[13]||(e[13]=l=>I(!0,!1))},{default:t(()=>[i(" 删除历史记录和源文件 ")]),_:1}),a(V,{color:"info",class:"mb-2 mx-2",onClick:e[14]||(e[14]=l=>I(!1,!0))},{default:t(()=>[i(" 删除历史记录和媒体库文件 ")]),_:1}),a(V,{color:"error",class:"mb-2 mx-2",onClick:e[15]||(e[15]=l=>I(!0,!0))},{default:t(()=>[i(" 删除历史记录、源文件和媒体库文件 ")]),_:1})])]),_:1})]),_:1},8,["modelValue"])],64)}}});const Re=O({__name:"history",setup(Z){return(w,g)=>(b(),Q(Ne))}});export{Re as default};
